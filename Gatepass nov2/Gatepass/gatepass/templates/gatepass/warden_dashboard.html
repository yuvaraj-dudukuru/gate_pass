{% extends 'gatepass/base.html' %}

{% block title %}Warden Dashboard - Hostel Gatepass System{% endblock %}

{% block content %}
<style>
    :root {
        --primary-light: #e6f2ff;
        --success-light: #e6f9f0;
        --warning-light: #fff8e6;
        --danger-light: #ffe6e6;
        --info-light: #e6faff;
    }
    .stat-card {
        border: none;
        border-radius: 12px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    .stat-card .card-body {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    .stat-card .icon-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }
    .nav-pills .nav-link {
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    .nav-pills .nav-link.active {
        background-color: var(--bs-primary);
        color: #fff;
        box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
    }
    .table-hover tbody tr {
        transition: background-color 0.2s ease;
    }
    .empty-state {
        padding: 4rem 2rem;
        border: 2px dashed #e0e0e0;
        border-radius: 12px;
        background-color: #f8f9fa;
    }
</style>

<div class="page-header mb-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div>
            <h1 class="fw-bold">Warden Dashboard</h1>
            <p class="mb-0 text-muted">Prioritize pending approvals and monitor student status.</p>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4 g-4">
    <div class="col-lg-3 col-md-6">
        <div class="card stat-card shadow-sm h-100">
            <div class="card-body">
                <div class="icon-circle bg-warning-light text-warning">
                    <i class="fas fa-clock"></i>
                </div>
                <div>
                    <h6 class="text-muted mb-1">Pending</h6>
                    <h3 class="fw-bold mb-0">{{ total_pending }}</h3>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="card stat-card shadow-sm h-100">
            <div class="card-body">
                <div class="icon-circle bg-info-light text-info">
                    <i class="fas fa-user-clock"></i>
                </div>
                <div>
                    <h6 class="text-muted mb-1">Students Out</h6>
                    <h3 class="fw-bold mb-0">{{ students_out }}</h3>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4">
        <div class="card stat-card shadow-sm h-100">
            <div class="card-body">
                <div class="icon-circle bg-success-light text-success">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div>
                    <h6 class="text-muted mb-1">Approved</h6>
                    <h3 class="fw-bold mb-0">{{ total_approved }}</h3>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4">
        <div class="card stat-card shadow-sm h-100">
            <div class="card-body">
                <div class="icon-circle bg-danger-light text-danger">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div>
                    <h6 class="text-muted mb-1">Rejected</h6>
                    <h3 class="fw-bold mb-0">{{ total_rejected }}</h3>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4">
        <div class="card stat-card shadow-sm h-100">
            <div class="card-body">
                <div class="icon-circle bg-primary-light text-primary">
                    <i class="fas fa-house-user"></i>
                </div>
                <div>
                    <h6 class="text-muted mb-1">Returned</h6>
                    <h3 class="fw-bold mb-0">{{ total_returned }}</h3>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filter Accordion -->
<div class="accordion mb-4" id="filterAccordion">
    <div class="accordion-item border-0 shadow-sm">
        <h2 class="accordion-header" id="headingOne">
            <button class="accordion-button collapsed bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFilter" aria-expanded="false" aria-controls="collapseFilter">
                <i class="fas fa-filter me-2"></i>Filter Gatepass Requests & Debug
            </button>
        </h2>
        <div id="collapseFilter" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#filterAccordion">
            <div class="accordion-body">
                <form method="get" class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label for="{{ filter_form.from_date.id_for_label }}" class="form-label">From Date</label>
                        {{ filter_form.from_date }}
                    </div>
                    <div class="col-md-3">
                        <label for="{{ filter_form.to_date.id_for_label }}" class="form-label">To Date</label>
                        {{ filter_form.to_date }}
                    </div>
                    <div class="col-md-3">
                        <label for="{{ filter_form.status_filter.id_for_label }}" class="form-label">Status</label>
                        {{ filter_form.status_filter }}
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-primary w-100"><i class="fas fa-search me-1"></i>Filter</button>
                    </div>
                </form>
                {% if filtered_count %}
                <div class="mt-3 d-flex align-items-center gap-2">
                    <span class="badge bg-info-light text-info">Showing {{ filtered_count }} result(s)</span>
                    <a href="{% url 'warden_dashboard' %}" class="btn btn-sm btn-outline-secondary"><i class="fas fa-times me-1"></i>Clear</a>
                </div>
                {% endif %}
                <hr>
                <a href="{% url 'warden_debug' %}" class="btn btn-sm btn-outline-info mt-2"><i class="fas fa-bug me-1"></i>Debug Details</a>
            </div>
        </div>
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-pills nav-fill flex-column flex-md-row mb-4" id="wardenTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending-tab-pane" type="button" role="tab" aria-controls="pending-tab-pane" aria-selected="true">
            <i class="fas fa-inbox me-1"></i> Pending <span class="badge rounded-pill bg-light text-dark ms-1">{{ total_pending }}</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="students-out-tab" data-bs-toggle="tab" data-bs-target="#students-out-tab-pane" type="button" role="tab" aria-controls="students-out-tab-pane" aria-selected="false">
            <i class="fas fa-user-clock me-1"></i> Students Out <span class="badge rounded-pill bg-light text-dark ms-1">{{ students_out }}</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="returned-tab" data-bs-toggle="tab" data-bs-target="#returned-tab-pane" type="button" role="tab" aria-controls="returned-tab-pane" aria-selected="false">
            <i class="fas fa-house-user me-1"></i> Returned <span class="badge rounded-pill bg-light text-dark ms-1">{{ total_returned }}</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="approved-tab" data-bs-toggle="tab" data-bs-target="#approved-tab-pane" type="button" role="tab" aria-controls="approved-tab-pane" aria-selected="false">
            <i class="fas fa-check-circle me-1"></i> Approved <span class="badge rounded-pill bg-light text-dark ms-1">{{ total_approved }}</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="rejected-tab" data-bs-toggle="tab" data-bs-target="#rejected-tab-pane" type="button" role="tab" aria-controls="rejected-tab-pane" aria-selected="false">
            <i class="fas fa-times-circle me-1"></i> Rejected <span class="badge rounded-pill bg-light text-dark ms-1">{{ total_rejected }}</span>
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="wardenTabContent">
    <!-- Pending Requests -->
    <div class="tab-pane fade show active" id="pending-tab-pane" role="tabpanel" aria-labelledby="pending-tab" tabindex="0">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-3">
                <h5 class="fw-bold"><i class="fas fa-inbox me-2 text-warning"></i>Pending Gatepass Requests</h5>
            </div>
            <div class="card-body">
                {% if pending_requests %}
                    {% with list_type="pending" request_list=pending_requests empty_message=empty_pending %}
                        {% include "gatepass/partials/_request_list.html" %}
                    {% endwith %}
                {% else %}
                <div class="empty-state text-center">
                    <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
                    <h5 class="fw-bold">No Pending Requests</h5>
                    <p class="text-muted">All gatepass requests have been processed.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Other tabs content would follow a similar improved structure -->
    <!-- Students Out -->
    <div class="tab-pane fade" id="students-out-tab-pane" role="tabpanel" aria-labelledby="students-out-tab" tabindex="0">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-3">
                <h5 class="fw-bold"><i class="fas fa-user-clock me-2 text-info"></i>Students Currently Out</h5>
            </div>
            <div class="card-body">
                {% if students_out_requests %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Student</th>
                                <th>Out Since</th>
                                <th>Expected Return</th>
                                <th>Purpose</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for request in students_out_requests %}
                            <tr>
                                <td>
                                    <div class="fw-bold">{{ request.student.student_name }}</div>
                                    <div class="small text-muted">{{ request.student.hall_ticket_no }}</div>
                                </td>
                                <td>{{ request.outing_date }} {{ request.outing_time }}</td>
                                <td>{{ request.expected_return_date }} {{ request.expected_return_time }}</td>
                                <td>{{ request.purpose|truncatechars:30 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state text-center">
                    <i class="fas fa-user-check fa-4x text-info mb-3"></i>
                    <h5 class="fw-bold">No Students Out</h5>
                    <p class="text-muted">All students are currently in the hostel.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Returned -->
    <div class="tab-pane fade" id="returned-tab-pane" role="tabpanel" aria-labelledby="returned-tab" tabindex="0">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-3">
                <h5 class="fw-bold"><i class="fas fa-house-user me-2 text-primary"></i>Recently Returned</h5>
            </div>
            <div class="card-body">
                {% if returned_requests %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Student</th>
                                <th>Returned On</th>
                                <th>Verified By</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for request in returned_requests %}
                            <tr>
                                <td>
                                    <div class="fw-bold">{{ request.student.student_name }}</div>
                                    <div class="small text-muted">{{ request.student.hall_ticket_no }}</div>
                                </td>
                                <td>{{ request.actual_return_date }} {{ request.actual_return_time }}</td>
                                <td>{{ request.return_verified_by.username|default:"N/A" }}</td>
                                <td>{{ request.return_notes|truncatechars:30|default:"-" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state text-center">
                    <i class="fas fa-home fa-4x text-primary mb-3"></i>
                    <h5 class="fw-bold">No Recent Returns</h5>
                    <p class="text-muted">Students who have returned will appear here.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Approved -->
    <div class="tab-pane fade" id="approved-tab-pane" role="tabpanel" aria-labelledby="approved-tab" tabindex="0">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-3">
                <h5 class="fw-bold"><i class="fas fa-check-circle me-2 text-success"></i>Recently Approved</h5>
            </div>
            <div class="card-body">
                {% if approved_requests %}
                <ul class="list-group list-group-flush">
                    {% for request in approved_requests %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold">{{ request.student.student_name }}</div>
                            <div class="small text-muted">{{ request.outing_date }}</div>
                        </div>
                        <span class="badge bg-success-light text-success">Approved</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <div class="empty-state text-center">
                    <i class="fas fa-clipboard-check fa-4x text-success mb-3"></i>
                    <h5 class="fw-bold">No Recent Approvals</h5>
                    <p class="text-muted">Approved requests will appear here.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Rejected -->
    <div class="tab-pane fade" id="rejected-tab-pane" role="tabpanel" aria-labelledby="rejected-tab" tabindex="0">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-3">
                <h5 class="fw-bold"><i class="fas fa-times-circle me-2 text-danger"></i>Recently Rejected</h5>
            </div>
            <div class="card-body">
                {% if rejected_requests %}
                <ul class="list-group list-group-flush">
                    {% for request in rejected_requests %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold">{{ request.student.student_name }}</div>
                            <div class="small text-muted">{{ request.outing_date }}</div>
                        </div>
                        <div>
                            <span class="badge bg-danger-light text-danger">Rejected</span>
                            <div class="small text-muted mt-1">{{ request.warden_rejection_reason|truncatechars:20 }}</div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <div class="empty-state text-center">
                    <i class="fas fa-ban fa-4x text-danger mb-3"></i>
                    <h5 class="fw-bold">No Recent Rejections</h5>
                    <p class="text-muted">Rejected requests will appear here.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}